# 供应链订货系统设计文档

## 1. 系统概述

本系统是一个B2B供应链订货平台，包含移动端APP和Web管理后台，支持门店向多供应商采购原物料，并提供订单管理、供应商管理等功能。

### 1.1 核心目标
- 门店可便捷地向多个供应商采购物料
- 供应商可高效管理订单
- 管理员可全局监控所有订单
- 支持无后台供应商的企业微信推送

### 1.2 系统架构

**移动端APP + 多角色Web后台**

> 📱 **技术选型说明**：由于小程序存在上架审核问题，移动端优先采用Android APK方案，后续可扩展iOS。

```
┌─────────────────────────────────────────────────────────────┐
│                    移动端APP (Android APK)                   │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │   门店端    │  │  供应商端   │  │  管理员端   │         │
│  │  (账号登录) │  │  (账号登录) │  │  (账号登录) │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
│         ↓                ↓                ↓                 │
│              根据登录账号自动识别角色并切换界面               │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                      Web管理后台                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │  门店后台   │  │ 供应商后台  │  │  管理后台   │         │
│  │  (账号登录) │  │  (账号登录) │  │  (账号登录) │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
│                                          ↓                  │
│                              ┌─────────────────────┐        │
│                              │ 主管理员 / 子管理员 │        │
│                              │   (权限分级管理)    │        │
│                              └─────────────────────┘        │
└─────────────────────────────────────────────────────────────┘
```

### 1.3 移动端技术方案

| 方案 | 说明 |
|------|------|
| 开发框架 | uni-app / React Native / Flutter（推荐uni-app，可同时生成APK和H5） |
| 发布方式 | APK直接下载安装，无需应用商店审核 |
| 更新机制 | 支持热更新 + 强制更新提示 |
| 后续扩展 | 可打包iOS（需企业签名或TestFlight） |

---

## 2. 用户角色

### 2.1 角色概览

| 角色 | 端口 | 主要功能 |
|------|------|----------|
| 门店用户 | APP + Web后台 | 浏览物料、加入购物车、下单、查看订单、数据统计 |
| 供应商 | APP + Web后台 | 查看/处理自己的订单、管理物料价格、打印送货单 |
| 主管理员 | APP + Web后台 | 全部管理权限，可设置子管理员权限 |
| 子管理员 | APP + Web后台 | 根据主管理员分配的权限操作 |

### 2.2 管理员权限体系

#### 2.2.1 主管理员
- 系统初始化时创建，全局唯一
- 拥有所有功能权限
- 可创建/编辑/删除子管理员
- 可分配子管理员权限
- 可修改敏感配置（支付、API等）

#### 2.2.2 子管理员
- 由主管理员创建
- 权限由主管理员分配
- 不可修改敏感配置
- 不可管理其他管理员账号

#### 2.2.3 权限模块

| 权限模块 | 说明 | 主管理员 | 子管理员 |
|---------|------|:--------:|:--------:|
| 订单管理 | 查看/处理订单、取消审批 | ✅ | 可配置 |
| 数据报表 | 查看数据汇总、导出报表 | ✅ | 可配置 |
| 供应商管理 | 供应商增删改、代管设置 | ✅ | 可配置 |
| 门店管理 | 门店增删改、地址维护 | ✅ | 可配置 |
| 物料管理 | 物料/分类增删改 | ✅ | 可配置 |
| 素材库 | 图片管理、匹配规则 | ✅ | 可配置 |
| 产品审核 | 审核供应商导入的产品 | ✅ | 可配置 |
| 加价管理 | 加价规则配置 | ✅ | 可配置 |
| 配送设置审核 | 审核供应商配送设置变更 | ✅ | 可配置 |
| Webhook配置 | 门店/供应商群通知配置 | ✅ | 可配置 |
| **支付配置** | 支付接口配置（敏感） | ✅ | ❌ |
| **API配置** | 供应商API对接配置（敏感） | ✅ | ❌ |
| **系统设置** | 系统参数配置（敏感） | ✅ | ❌ |
| **管理员管理** | 子管理员增删改、权限分配 | ✅ | ❌ |

#### 2.2.4 APP端说明
- APP端主管理员和子管理员界面完全相同
- 权限管理功能仅在Web后台提供
- APP通过账号密码登录识别用户角色

### 2.3 登录与身份识别

APP通过账号密码登录识别用户身份：

```
用户打开APP
       ↓
  输入账号密码登录
       ↓
  服务端验证并返回用户信息
       ↓
┌──────┴──────┐
↓             ↓
单角色        多角色
↓             ↓
直接进入      显示角色选择页面
对应界面      (选择要使用的身份)
```

**登录规则：**
- 一个账号可绑定多个角色（如：既是门店A的管理员，又是供应商B的负责人）
- 多角色用户登录后可切换身份
- 支持记住登录状态（Token有效期可配置）
- 支持手机号+验证码登录（可选）

---

## 3. 功能模块

### 3.1 APP门店端

#### 3.1.1 物料浏览与选购
- 按分类浏览原物料
- 支持搜索物料名称/编号
- 查看物料详情（规格、尺寸、图片、描述）
- 根据门店所在区域自动筛选可配送的供应商
- 同一物料展示多个供应商的报价对比（仅显示可配送到当前门店的供应商）
  - 显示：供应商名称、单价、起送价、预计配送时间
- 选择供应商和数量后加入购物车

#### 3.1.2 购物车
- 按供应商分组展示商品
- 每个供应商组显示：
  - 当前小计金额
  - 起送价提示（未达到时高亮警告）
  - 预计配送时间
- 支持修改数量、删除商品
- **分批结算机制**：
  - 已达起送价的供应商：可直接结算支付
  - 未达起送价的供应商：需继续凑单，暂不可结算
  - 结算时只提交已达起送价的供应商订单
  - 未达起送价的商品保留在购物车中，等待凑单

#### 3.1.3 结算与下单
- 仅结算已达起送价的供应商商品
- 按供应商拆分订单（一次结算可能生成多个订单）
- 收货地址（仅显示，不可修改，由管理员维护）
- 显示预计送达日期（根据供应商配送日自动计算）
- 备注信息
- 确认订单信息后提交
- 未达起送价的商品保留在购物车，提示用户继续凑单

#### 3.1.4 订单管理
- 查看历史订单列表
- 订单状态跟踪：待付款 → 待确认 → 已确认 → 配送中 → 已完成
- 订单详情查看
- 支持再次购买（快速复制订单到购物车）
- 订单取消功能：
  - 下单后1小时内：可自主取消，自动推送Webhook通知供应商
  - 下单后超过1小时：提交取消申请，等待管理员审批
  - 取消申请状态跟踪
- 待付款订单：恢复的订单需重新付款

---

### 3.2 Web管理后台

#### 3.2.1 门店端功能

**首页数据看板**
- 本月订货金额/订单数
- 订货趋势图（按日/周/月）
- 常购物料TOP10
- 各供应商订货占比

**在线订货（Web端下单）**
- 物料浏览与搜索
  - 按分类浏览原物料
  - 支持搜索物料名称/编号
  - 查看物料详情（规格、尺寸、图片、描述）
  - 同一物料展示多个供应商的报价对比
- 购物车管理
  - 按供应商分组展示商品
  - 显示起送价提示
  - 支持修改数量、删除商品
- 结算下单
  - 按供应商拆分订单
  - 收货地址（仅显示，不可修改，由管理员维护）
  - 显示预计送达日期（根据供应商配送日自动计算）
  - 填写备注信息
- 在线支付
  - 支持微信支付/支付宝
  - 生成支付二维码，扫码完成支付
  - 支付状态实时更新
  - 支付超时自动取消（可配置）

**订单管理**
- 查看历史订单列表（支持筛选：状态、日期、供应商）
- 订单详情查看
- 待付款订单：显示支付二维码，支持重新支付
- 订单取消功能（同APP端规则）
- 导出订单明细（Excel）

**订货统计**
- 按时间段统计订货金额
- 按物料分类统计
- 按供应商统计
- 支持导出报表

---

#### 3.2.2 供应商端功能

**订单管理**
- 查看自己的订单列表（支持筛选：状态、日期、门店）
- 订单详情查看
- 确认订单 / 标记配送中 / 完成订单
- 导出订单（Excel）

**物料管理**
- 查看/编辑自己供应的物料价格
- 设置物料库存状态（有货/缺货）
- 批量导入价格

**配送设置**（提交后需管理员审核）
- 设置起送价格
- 配送日期设置
  - 按周几配送（如：周一、周三、周五送货）
  - 支持多选配送日
  - 系统自动计算实际送达日期（如今日周五，周一送货则显示"下周一送达"）
- 配送区域管理
  - 添加/删除可配送的省市区
  - 支持批量导入配送区域
  - 可按区域设置不同起送价（可选扩展）
- 配送设置变更需管理员审核后生效

**数据导入导出**
- Excel批量导入物料价格
- Excel导入模板下载
- 导入历史记录与错误日志

**送货单打印**
- 订单送货单打印（支持批量打印）
- 自定义送货单模板
- 送货单包含：订单信息、商品明细、收货信息、签收栏

#### 3.2.3 管理员端功能

**首页数据看板**
- 今日/本周/本月订单数、订货总金额
- 订单状态分布（待确认/已确认/配送中/已完成）
- 订货趋势图（按日/周/月）
- 各供应商订单量排行
- 各门店订货金额排行
- 热门物料TOP10

**订单管理**
- 查看所有订单（支持多维度筛选：门店、供应商、状态、日期）
- 订单详情与状态跟踪
- 导出订单数据
- 取消申请审批：
  - 查看待审批的取消申请列表
  - 联系供应商确认是否可取消
  - 批准或拒绝取消申请
  - 批准后自动推送Webhook取消通知
- 订单恢复功能：
  - 供应商拒绝取消时，可恢复已取消的订单
  - 恢复后订单状态变为"待付款"
  - 通知门店重新付款
  - 推送Webhook恢复通知给供应商
- 管理员直接取消订单（任意状态）

**数据汇总与报表**
- 订货汇总报表
  - 按门店汇总：各门店订货金额、订单数、常购物料
  - 按供应商汇总：各供应商销售金额、订单数、热销物料
  - 按物料汇总：各物料销量、销售额、采购门店数
  - 按时间汇总：日/周/月订货趋势
- 对比分析
  - 同比/环比分析
  - 门店订货排名变化
  - 供应商销售排名变化
- 报表导出（Excel/PDF）
- 定时报表（可配置每日/周/月自动生成）

**供应商管理**
- 供应商账号创建与管理
- 供应商信息维护（名称、联系方式、配送信息）
- 启用/禁用供应商
- 设置供应商是否有后台（无后台则启用企业微信推送）
- 设置供应商对接模式（见下方对接模式说明）

**供应商代管功能（针对不使用系统的供应商）**
- 管理员代为设置供应商物料价格
- 管理员代为设置起送价、配送时间、配送区域
- 管理员代为确认订单、更新订单状态
- Excel批量导入供应商物料价格
- 代管操作日志记录

**加价管理**
- 多级加价开关控制：
  - 全局总开关：关闭后所有加价停止
  - 供应商级开关：关闭后该供应商所有商品不加价
  - 门店级开关：关闭后该门店所有采购不加价
  - 分类级开关：关闭后该分类所有商品不加价
  - 规则级开关：单独启用/禁用某条加价规则
- 加价维度（可单独或组合使用）：
  - 按商品加价：针对特定物料设置加价
  - 按供应商加价：针对特定供应商的所有商品加价
  - 按门店加价：针对特定门店的所有采购加价
  - 按门店+供应商：针对特定门店从特定供应商采购加价
  - 按门店+商品：针对特定门店采购特定商品加价
  - 按供应商+商品：针对特定供应商的特定商品加价
  - 按门店+供应商+商品：最精细粒度，三者组合加价
- 加价方式支持：
  - 固定金额加价（如 +5元/件）
  - 百分比加价（如 +10%）
- 规则优先级：精细规则优先于通用规则
- Excel批量导入加价规则
- 加价预览与模拟计算
- 加价记录与统计报表

**加价规则说明**
- 门店端显示：加价后的最终价格（门店无感知）
- 供应商端显示：原始供货价格（不含加价）
- 订单结算：门店按加价后金额支付，供应商按原价结算，差价为平台收入

**加价规则示例**
| 规则类型 | 门店 | 供应商 | 商品 | 加价 | 说明 |
|---------|------|--------|------|------|------|
| 门店通用 | 城东旗舰店 | - | - | +5% | 该门店所有采购加价5% |
| 供应商通用 | - | 鑫源食品 | - | +3% | 从该供应商采购都加价3% |
| 商品通用 | - | - | 特级面粉 | +2元 | 所有面粉采购加价2元/件 |
| 门店+供应商 | 城东旗舰店 | 鑫源食品 | - | +8% | 该门店从该供应商采购加价8% |
| 门店+商品 | 大学城店 | - | 食用油 | 0 | 该门店买油不加价 |
| 供应商+商品 | - | 华东粮油 | 面粉 | +1元 | 该供应商的面粉加价1元 |
| 精确匹配 | 火车站店 | 绿源蔬菜 | 土豆 | +10% | 最精细规则，优先级最高 |

**加价开关层级**
```
全局总开关 (关闭=所有加价停止)
├── 供应商级开关
│   ├── 鑫源食品供应 [开启] → 该供应商商品参与加价
│   ├── 华东粮油批发 [关闭] → 该供应商所有商品不加价
│   └── 绿源蔬菜配送 [开启]
├── 门店级开关
│   ├── 城东旗舰店 [开启] → 该门店采购参与加价
│   ├── 大学城店 [关闭] → 新店扶持，暂不加价
│   └── 万达广场店 [开启]
├── 分类级开关
│   ├── 粮油类 [开启]
│   ├── 蔬菜类 [开启]
│   └── 包装材料 [关闭] → 低毛利品类不加价
└── 规则级开关
    └── 每条规则可单独启用/禁用
```

**开关优先级逻辑**
1. 全局总开关关闭 → 不加价
2. 供应商开关关闭 → 该供应商不加价
3. 门店开关关闭 → 该门店不加价
4. 分类开关关闭 → 该分类不加价
5. 以上都开启 → 按规则计算加价

**加价计算逻辑**
```
1. 检查全局总开关
   - 关闭：返回原价
   - 开启：继续

2. 检查供应商级开关
   - 该供应商开关关闭：返回原价
   - 开启：继续

3. 检查门店级开关
   - 该门店开关关闭：返回原价
   - 开启：继续

4. 检查分类级开关
   - 该商品分类开关关闭：返回原价
   - 开启：继续

5. 查找匹配的加价规则（按优先级排序）
   优先级从高到低：
   - 门店+供应商+商品 精确匹配
   - 门店+供应商 / 门店+商品 / 供应商+商品
   - 仅门店 / 仅供应商 / 仅商品

6. 取优先级最高的已启用规则
   - 如果加价值为0，表示不加价
   - 如果无匹配规则，不加价

7. 计算最终价格
   - 百分比：最终价格 = 原价 × (1 + 加价百分比)
   - 固定金额：最终价格 = 原价 + 固定加价
   
8. 价格展示
   - 门店端：显示最终价格
   - 供应商端：显示原价
   - 管理员端：显示原价、加价、最终价格
```

**物料管理**
- 物料分类管理
- 物料基础信息管理（名称、规格、尺寸、图片）
- 物料与供应商关联
- 批量导入/导出物料

**素材库管理**
- 产品图片素材库
  - 按分类组织图片（粮油、肉禽蛋、蔬菜、调味品等）
  - 按品牌组织图片（金龙鱼、鲁花、五得利等）
  - 支持批量上传图片
  - 图片标签管理（关键词、SKU编码、品牌）
- 图片匹配机制
  - 自动匹配：根据产品名称/SKU/品牌自动关联图片（默认开启）
  - 手动匹配：管理员手动为产品指定图片
  - 匹配规则配置：
    - 名称相似度阈值
    - 品牌精确匹配（同品牌优先）
    - 规格匹配（同规格优先）
  - 注意事项：
    - 同一物料可能存在多个品牌，需区分匹配
    - 同品牌同物料可能有多种规格，需精确匹配
    - 不同供应商可能使用不同包装规格

**供应商产品审核**
- 供应商导入产品后进入待审核状态
- 审核内容：
  - 品牌信息核实（品牌名称是否正确、是否为新品牌）
  - 规格信息核实（规格描述是否准确、单位是否正确）
  - 价格合理性检查（与历史价格对比、与同品牌同规格对比）
  - 图片匹配检查（自动匹配结果确认、手动调整）
  - 产品信息完整性检查
- 审核流程：
  - 待审核 → 审核通过 / 审核驳回
  - 驳回需填写原因，供应商可修改后重新提交
- 批量审核支持

**门店管理**
- 门店账号创建与管理
- 门店信息维护
- 门店分组（可选）

**系统设置**
- 企业微信Webhook配置
- 系统参数配置
- 操作日志查看

**送货单管理**
- 送货单模板配置
- 批量打印送货单
- 打印记录查询

---

### 3.3 APP端（供应商/管理员）

#### 3.3.1 供应商APP功能
- 订单列表查看（待处理/进行中/已完成）
- 订单详情与状态更新
- 新订单消息推送通知
- 快捷确认/配送/完成操作
- 今日订单统计

#### 3.3.2 管理员APP功能
- 全平台订单概览
- 订单状态监控
- 异常订单提醒
- 快速查看门店/供应商信息
- 关键数据指标展示

---

## 4. 企业微信Webhook推送

### 4.1 多群推送机制

系统支持将订单通知推送到多个企业微信群，实现门店和供应商的同步通知：

**推送目标：**
- 门店管理群：每个门店可配置一个管理群，接收该门店所有订单通知
- 供应商群：每个供应商可配置一个群，接收该供应商相关的订单通知

**推送示例：**
一个订单包含3个供应商的商品，系统会推送到4个群：
1. 门店管理群（汇总订单信息）
2. 供应商A群（仅该供应商的商品明细）
3. 供应商B群（仅该供应商的商品明细）
4. 供应商C群（仅该供应商的商品明细）

### 4.2 触发场景

| 事件 | 门店群 | 供应商群 | 说明 |
|------|--------|----------|------|
| 门店下单成功 | ✅ | ✅ | 门店群收到汇总，供应商群收到各自订单 |
| 订单状态变更 | ✅ | ✅ | 供应商确认/配送/完成时通知 |
| 订单取消 | ✅ | ✅ | 取消通知同步推送 |
| 订单恢复 | ✅ | ✅ | 恢复通知同步推送 |
| 供应商缺货 | ✅ | ❌ | 仅通知门店 |
| 配送异常 | ✅ | ✅ | 双方同步通知 |

### 4.3 推送内容

#### 4.3.1 新订单通知 - 门店群版本
```
【订单提交成功】✅
门店：城东旗舰店
订单时间：2024-12-27 10:30:00

📦 订单汇总（3个供应商）：
├─ 鑫源食品供应：¥1,280.00（2件）
├─ 华东粮油批发：¥860.00（3件）
└─ 绿源蔬菜配送：¥450.00（5件）

订单总额：¥2,590.00
服务费：¥7.77
实付金额：¥2,597.77

预计送达：
├─ 鑫源食品：下周一 (12/30)
├─ 华东粮油：下周二 (12/31)
└─ 绿源蔬菜：明天 (12/28)

订单已通知各供应商，请等待确认。
```

#### 4.3.2 新订单通知 - 供应商群版本
```
【新订单通知】📦
订单编号：PO20241227001
下单门店：城东旗舰店
下单时间：2024-12-27 10:30:00
订单金额：¥1,280.00
期望配送：下周一 (12/30)

商品明细：
1. 面粉（金龙鱼 25kg/袋）x 10袋 - ¥78.00/袋
2. 黄油（安佳 500g/块）x 10块 - ¥50.00/块

收货地址：XX市XX区XX路XX号
联系电话：138****8888
备注：请在上午10点前送达

请及时处理！
```

#### 4.3.3 订单取消通知 - 门店群版本
```
【订单取消通知】⚠️
门店：城东旗舰店
取消时间：2024-12-27 11:25:00

取消订单：
├─ 鑫源食品供应：PO20241227001（¥1,280.00）
取消原因：门店临时调整采购计划
取消方式：门店自主取消

已通知供应商，退款将原路返回。
```

#### 4.3.4 订单取消通知 - 供应商群版本
```
【订单取消通知】⚠️
订单编号：PO20241227001
下单门店：城东旗舰店
取消时间：2024-12-27 11:25:00
取消原因：门店临时调整采购计划
取消方式：门店自主取消

原订单金额：¥1,280.00

商品明细：
1. 面粉（金龙鱼 25kg/袋）x 10袋
2. 黄油（安佳 500g/块）x 10块

如有疑问请联系管理员。
```

#### 4.3.5 订单确认通知 - 门店群版本
```
【订单已确认】✅
供应商：鑫源食品供应
订单编号：PO20241227001
确认时间：2024-12-27 11:00:00

订单金额：¥1,280.00
预计送达：下周一 (12/30) 上午

商品明细：
1. 面粉（金龙鱼 25kg/袋）x 10袋
2. 黄油（安佳 500g/块）x 10块

供应商已确认接单，请准备收货。
```

#### 4.3.6 订单恢复通知
```
【订单恢复通知】🔄
订单编号：PO20241227001
下单门店：城东旗舰店
恢复时间：2024-12-27 12:00:00
恢复原因：供应商已备货，无法取消

订单金额：¥1,280.00
当前状态：待门店付款

商品明细：
1. 面粉（金龙鱼 25kg/袋）x 10袋
2. 黄油（安佳 500g/块）x 10块

订单已恢复，请继续处理。
```

### 4.4 Webhook配置

#### 4.4.1 门店Webhook配置
- 每个门店可配置一个企业微信群Webhook URL
- 配置位置：管理员后台 → 门店管理 → 门店详情 → Webhook配置
- 支持启用/禁用
- 支持测试推送

#### 4.4.2 供应商Webhook配置
- 每个供应商可配置一个企业微信群Webhook URL
- 配置位置：管理员后台 → 供应商管理 → 供应商详情 → Webhook配置
- 支持启用/禁用
- 支持测试推送
- 可选择推送事件类型（新订单/状态变更/取消/恢复）

#### 4.4.3 推送失败处理
- 推送失败自动重试（最多3次，间隔5分钟）
- 记录推送日志（成功/失败/重试）
- 连续失败告警通知管理员

---

## 5. 供应商对接模式

系统支持多种供应商对接模式，适应不同供应商的技术能力：

### 5.1 对接模式类型

| 模式 | 说明 | 适用场景 |
|------|------|----------|
| 自主管理 | 供应商登录系统自行管理订单和价格 | 有专人负责的供应商 |
| 平台代管 | 管理员代为管理价格和订单 | 不使用系统的小供应商 |
| Webhook推送 | 订单推送到企业微信 | 无系统但需要通知的供应商 |
| API对接 | 订单推送到供应商系统 | 有自己系统的供应商 |

### 5.2 供应商API对接

#### 5.2.1 订单推送接口（系统 → 供应商）

当门店下单后，系统主动将订单推送到供应商配置的接口地址。

**请求方式：** POST

**请求头：**
```
Content-Type: application/json
X-Signature: {签名}
X-Timestamp: {时间戳}
```

**请求体：**
```json
{
  "event": "order.created",
  "order": {
    "order_no": "PO202412270001",
    "store": {
      "id": "S001",
      "name": "城东旗舰店",
      "address": "XX市XX区XX路XX号",
      "contact_name": "张经理",
      "contact_phone": "138****8888"
    },
    "items": [
      {
        "material_id": "M001",
        "material_name": "特级面粉",
        "spec": "25kg/袋",
        "quantity": 10,
        "unit_price": 78.00,
        "subtotal": 780.00
      }
    ],
    "total_amount": 780.00,
    "expected_delivery_time": "2024-12-28 上午",
    "remark": "请在上午10点前送达",
    "created_at": "2024-12-27T10:30:00+08:00"
  }
}
```

**事件类型：**
- `order.created` - 新订单创建
- `order.cancelled` - 订单取消
- `order.restored` - 订单恢复（供应商拒绝取消后恢复）

#### 5.2.2 订单状态回调接口（供应商 → 系统）

供应商系统可调用此接口更新订单状态。

**接口地址：** `POST /api/v1/supplier/orders/{order_no}/status`

**请求头：**
```
Content-Type: application/json
Authorization: Bearer {supplier_token}
```

**请求体：**
```json
{
  "status": "confirmed",
  "remark": "已确认，预计明天上午送达"
}
```

**状态值：**
- `confirmed` - 已确认
- `delivering` - 配送中
- `completed` - 已完成

#### 5.2.3 签名验证

推送请求使用 HMAC-SHA256 签名验证：

```
signature = HMAC-SHA256(timestamp + requestBody, secretKey)
```

供应商在管理后台获取 `secretKey`，用于验证请求来源。

### 5.3 对接配置

管理员在供应商管理中配置：

| 配置项 | 说明 |
|--------|------|
| 对接模式 | 自主管理/平台代管/Webhook/API对接 |
| 推送地址 | Webhook URL 或 API 接口地址 |
| 密钥 | 用于签名验证的 Secret Key |
| 推送事件 | 选择需要推送的事件类型 |
| 重试策略 | 推送失败时的重试次数和间隔 |

---

## 5. 数据模型

### 5.1 核心实体

```
用户 (User)
├── id
├── username
├── password_hash
├── role (admin/sub_admin/supplier/store)
├── phone
├── created_at
└── status

管理员 (Admin)
├── id
├── user_id
├── name
├── is_primary (是否主管理员: 1是/0否)
├── permissions (权限JSON数组，主管理员为空表示全部权限)
├── created_by (创建人ID，主管理员为空)
├── created_at
└── status

# 权限标识说明：
# - order: 订单管理
# - report: 数据报表
# - supplier: 供应商管理
# - store: 门店管理
# - material: 物料管理
# - media: 素材库
# - product_audit: 产品审核
# - markup: 加价管理
# - delivery_audit: 配送设置审核
# - webhook: Webhook配置
# 以下为敏感权限，仅主管理员可用：
# - payment_config: 支付配置
# - api_config: API配置
# - system_config: 系统设置
# - admin_manage: 管理员管理

微信绑定 (WechatBinding)
├── id
├── openid (微信OpenID)
├── unionid (微信UnionID，可选)
├── user_id (关联用户ID)
├── role (绑定角色: admin/supplier/store)
├── bindable_id (关联ID：管理员ID/供应商ID/门店ID)
├── bindable_type (关联类型: admin/supplier/store)
├── nickname (微信昵称)
├── avatar (微信头像)
├── bindtime
└── status

门店 (Store)
├── id
├── user_id
├── name
├── address
├── province (省)
├── city (市)
├── district (区/县)
├── contact_name
├── contact_phone
├── markup_enabled (加价开关: 1开启/0关闭，新店扶持期可关闭)
├── wechat_webhook_url (企业微信群Webhook地址)
├── webhook_enabled (Webhook开关: 1开启/0关闭)
└── status

供应商 (Supplier)
├── id
├── user_id
├── name (供应商真实名称)
├── display_name (门店端显示名称，默认为name，管理员可修改)
├── contact_name
├── contact_phone
├── min_order_amount (起送价)
├── delivery_days (配送日JSON数组，如: [1,3,5] 表示周一三五送货)
├── delivery_mode (配送模式: self_delivery/express_delivery)
├── management_mode (管理模式: self/managed/webhook/api)
├── has_backend (是否有后台)
├── wechat_webhook_url (企业微信群Webhook地址)
├── webhook_enabled (Webhook开关: 1开启/0关闭)
├── webhook_events (推送事件配置JSON，如: ["order.created","order.cancelled"])
├── api_endpoint (API对接地址)
├── api_secret_key (API密钥)
├── push_events (推送事件配置JSON)
├── markup_enabled (加价开关: 1开启/0关闭)
└── status

# 显示名称说明：
# - display_name 用于门店端展示，默认等于 name
# - 管理员可在后台修改 display_name，不影响供应商真实名称
# - 供应商后台、管理员后台显示真实名称 name
# - 门店APP、门店Web后台显示 display_name

# 配送模式说明：
# - self_delivery: 供应商自配送，供应商使用自己的车辆/人员配送，无需上传运单
# - express_delivery: 快递配送，使用第三方快递公司配送，需要上传快递运单号便于追踪
# - 默认为 self_delivery（供应商自配送）

Webhook推送日志 (WebhookLog)
├── id
├── target_type (推送目标类型: store/supplier)
├── target_id (门店ID或供应商ID)
├── event_type (事件类型: order.created/order.cancelled等)
├── order_id (关联订单ID)
├── webhook_url (推送地址)
├── request_body (请求内容JSON)
├── response_code (响应状态码)
├── response_body (响应内容)
├── status (推送状态: success/failed/pending)
├── retry_count (重试次数)
├── created_at
└── updated_at

供应商配送设置变更审核 (SupplierSettingAudit)
├── id
├── supplier_id
├── change_type (变更类型: delivery_days/min_order/delivery_area)
├── old_value (原值JSON)
├── new_value (新值JSON)
├── status (pending/approved/rejected)
├── submit_time
├── audit_time
├── auditor_id
└── reject_reason

配送区域 (DeliveryArea)
├── id
├── supplier_id
├── province (省)
├── city (市)
├── district (区/县)
└── status

加价规则 (PriceMarkup)
├── id
├── name (规则名称)
├── store_id (门店ID，可为空表示全部门店)
├── supplier_id (供应商ID，可为空表示全部供应商)
├── material_id (物料ID，可为空表示全部物料)
├── markup_type (加价方式: fixed/percent)
├── markup_value (加价值)
├── priority (优先级，自动根据精细度计算)
├── is_active (是否启用)
├── created_at
└── updated_at

# 规则精细度说明：
# - 门店+供应商+商品：优先级最高 (7)
# - 门店+供应商 / 门店+商品 / 供应商+商品：优先级次之 (4-6)
# - 仅门店 / 仅供应商 / 仅商品：优先级较低 (1-3)
# - 匹配时取优先级最高的规则

系统配置 (SystemConfig)
├── id
├── key
├── value
└── updated_at
(包含: markup_global_enabled 全局加价开关)

物料分类 (Category)
├── id
├── name
├── sort_order
├── parent_id
└── markup_enabled (加价开关: 1开启/0关闭，低毛利分类可关闭)

物料 (Material) - 基础物料信息
├── id
├── category_id
├── name (物料通用名称，如"面粉"、"食用油")
├── description
├── image_url (默认图片)
└── status

物料SKU (MaterialSku) - 具体规格品牌
├── id
├── material_id
├── brand (品牌，如"金龙鱼"、"鲁花")
├── spec (规格，如"25kg/袋"、"5L/桶")
├── unit (销售单位，如"袋"、"桶"、"箱")
├── barcode (条形码)
├── image_url (SKU专属图片，可覆盖物料默认图)
└── status

供应商物料 (SupplierMaterial) - 供应商报价
├── id
├── supplier_id
├── material_sku_id (关联到具体SKU)
├── price (供应商报价)
├── min_quantity (最小起订量，如"1箱起订")
├── stock_status (有货/缺货)
├── audit_status (审核状态: pending/approved/rejected)
└── updated_at

```
物料层级关系示例：
物料(Material): 面粉
  ├── SKU1: 金龙鱼 特级面粉 25kg/袋
  │     ├── 供应商A报价: ¥78/袋 (1袋起订)
  │     └── 供应商B报价: ¥75/袋 (10袋起订)
  ├── SKU2: 金龙鱼 特级面粉 50kg/袋
  │     └── 供应商A报价: ¥150/袋
  ├── SKU3: 五得利 特级面粉 25kg/袋
  │     ├── 供应商B报价: ¥72/袋
  │     └── 供应商C报价: ¥70/袋 (1箱=5袋起订)
  └── SKU4: 香满园 高筋面粉 25kg/袋
        └── 供应商A报价: ¥82/袋
```

订单 (Order)
├── id
├── order_no
├── store_id
├── supplier_id
├── goods_amount (商品金额，含加价)
├── service_fee (支付手续费 = goods_amount × 0.003)
├── total_amount (门店实付总额 = goods_amount + service_fee)
├── supplier_amount (供应商结算金额，原价不含加价)
├── markup_total (加价总额 = goods_amount - supplier_amount)
├── status (pending/confirmed/delivering/completed/cancelled/unpaid)
├── payment_status (支付状态: unpaid/paid/refunded)
├── payment_method (支付方式: wechat/alipay/offline)
├── payment_time (支付时间)
├── payment_no (支付流水号)
├── order_source (订单来源: miniapp/web)
├── delivery_address
├── delivery_contact
├── delivery_phone
├── expected_delivery_time
├── remark
├── cancel_reason (取消原因)
├── cancelled_by (取消人: store/admin)
├── cancelled_at (取消时间)
├── restored_at (恢复时间，订单被恢复时记录)
├── created_at
└── updated_at

# 金额说明：
# - goods_amount: 商品金额（供应商原价 + 平台加价）
# - service_fee: 支付手续费（3‰），由门店承担
# - total_amount: 门店实际支付金额
# - supplier_amount: 供应商收到的金额（原价）
# - markup_total: 平台加价收入
# - 平台总收入 = markup_total + service_fee

支付记录 (PaymentRecord)
├── id
├── order_id
├── order_no
├── payment_no (支付流水号)
├── payment_method (支付方式: wechat/alipay)
├── goods_amount (商品金额)
├── service_fee (手续费)
├── amount (实付金额 = goods_amount + service_fee)
├── status (pending/success/failed/refunded)
├── qrcode_url (支付二维码URL)
├── qrcode_expire_time (二维码过期时间)
├── trade_no (第三方交易号)
├── pay_time (实际支付时间)
├── refund_time (退款时间)
├── refund_amount (退款金额，含手续费)
├── created_at
└── updated_at

订单取消申请 (OrderCancelRequest)
├── id
├── order_id
├── store_id
├── reason (取消原因)
├── status (pending/approved/rejected/auto_cancelled)
├── admin_id (处理管理员ID)
├── admin_remark (管理员备注)
├── supplier_reject_reason (供应商拒绝原因)
├── created_at
└── processed_at

订单明细 (OrderItem)
├── id
├── order_id
├── material_id
├── material_name
├── spec
├── unit
├── quantity
├── unit_price (供应商原价)
├── markup_amount (加价金额)
├── final_price (门店支付单价 = unit_price + markup_amount)
└── subtotal (小计 = final_price × quantity)
```

### 5.2 实体关系图

```
┌─────────┐     ┌─────────┐     ┌──────────┐
│  User   │────<│  Store  │────<│  Order   │
└─────────┘     └─────────┘     └──────────┘
     │               │               │
     │               │               │
     ▼               │               ▼
┌──────────┐         │         ┌────────────┐
│ Supplier │─────────┼────────>│ OrderItem  │
└──────────┘         │         └────────────┘
     │               │               │
     │               │               │
     ▼               ▼               ▼
┌──────────────┐  匹配关系    ┌──────────┐
│ DeliveryArea │◄────────────>│ Material │
└──────────────┘              └──────────┘
(供应商配送区域与                   │
 门店所在区域匹配)                  ▼
                              ┌──────────┐
                              │ Category │
                              └──────────┘
```

### 5.3 供应商区域匹配逻辑

门店浏览物料时，系统根据以下规则筛选可用供应商：

```
1. 获取门店所在区域 (province, city, district)
2. 查询 DeliveryArea 表，找出配送区域覆盖该门店的供应商
3. 匹配规则（优先级从高到低）：
   - 精确匹配：省 + 市 + 区 完全一致
   - 市级匹配：省 + 市 一致，区为空（表示全市配送）
   - 省级匹配：省一致，市和区为空（表示全省配送）
4. 返回匹配的供应商列表及其物料报价
```

---

## 6. 业务流程

### 6.1 门店下单流程

```
┌─────────────────────────────────────────────────────────────┐
│                   门店下单流程（APP/Web端）                   │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │   浏览物料列表   │
                    │   (APP/Web端)    │
                    └─────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │ 查看物料详情     │
                    │ (多供应商报价)   │
                    └─────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │ 选择供应商+数量  │
                    │ 加入购物车       │
                    └─────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │   查看购物车     │
                    │ (按供应商分组)   │
                    └─────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │  检查起送价格    │◄────┐
                    └─────────────────┘     │
                              │             │
                    ┌─────────┴─────────┐   │
                    ▼                   ▼   │
              [达到起送价]         [未达到] ─┘
                    │              (提示继续选购)
                    ▼
                    ┌─────────────────┐
                    │   确认结算      │
                    │ (填写配送信息)  │
                    └─────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │  按供应商拆单    │
                    │  生成待付款订单  │
                    └─────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │    在线支付     │
                    │ (见6.1.1支付流程)│
                    └─────────────────┘
                              │
                              ▼
              ┌───────────────┼───────────────┐
              ▼               ▼               ▼
        [供应商A订单]   [供应商B订单]   [供应商C订单]
              │               │               │
              ▼               ▼               ▼
        ┌──────────┐   ┌──────────┐   ┌──────────┐
        │ 有后台？ │   │ 有后台？ │   │ 有后台？ │
        └──────────┘   └──────────┘   └──────────┘
           │  │           │  │           │  │
          是  否         是  否         是  否
           │   │          │   │          │   │
           ▼   ▼          ▼   ▼          ▼   ▼
        [等待] [推送]  [等待] [推送]  [等待] [推送]
        [登录] [企微]  [登录] [企微]  [登录] [企微]
        [查看]         [查看]         [查看]
```

#### 6.1.1 支付流程

```
┌─────────────────────────────────────────────────────────────┐
│                        支付流程                              │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │  选择支付方式   │
                    │ 微信/支付宝     │
                    └─────────────────┘
                              │
              ┌───────────────┴───────────────┐
              ▼                               ▼
          [APP端]                         [Web端]
              │                               │
              ▼                               ▼
    ┌─────────────────┐             ┌─────────────────┐
    │  调起支付SDK    │             │  生成支付二维码 │
    │  (微信/支付宝)  │             │  (Native支付)   │
    └─────────────────┘             └─────────────────┘
              │                               │
              ▼                               ▼
    ┌─────────────────┐             ┌─────────────────┐
    │  用户确认支付   │             │  用户扫码支付   │
    └─────────────────┘             └─────────────────┘
              │                               │
              └───────────────┬───────────────┘
                              ▼
                    ┌─────────────────┐
                    │  支付结果回调   │
                    └─────────────────┘
                              │
              ┌───────────────┴───────────────┐
              ▼                               ▼
        [支付成功]                       [支付失败/超时]
              │                               │
              ▼                               ▼
    ┌─────────────────┐             ┌─────────────────┐
    │  订单状态改为   │             │  订单保持待付款 │
    │  "待确认"       │             │  可重新支付     │
    └─────────────────┘             └─────────────────┘
              │                               │
              ▼                               ▼
    ┌─────────────────┐             ┌─────────────────┐
    │  推送订单通知   │             │  超时自动取消   │
    │  给供应商       │             │  (可配置时间)   │
    └─────────────────┘             └─────────────────┘
```

**Web端支付二维码说明：**
- 用户在Web端提交订单后，系统生成支付二维码
- 二维码有效期默认15分钟（可配置）
- 用户使用微信/支付宝扫码完成支付
- 页面实时轮询支付状态，支付成功后自动跳转
- 二维码过期可点击刷新重新生成
- 支持切换支付方式（微信↔支付宝）

### 6.2 订单状态流转

```
                                    ┌─────────────────────────────────────────────────────────────────┐
                                    │                        正常流程                                  │
                                    └─────────────────────────────────────────────────────────────────┘
                                    
┌──────────┐    供应商确认    ┌──────────┐    开始配送    ┌──────────┐    确认收货    ┌──────────┐
│  待确认  │ ───────────────> │  已确认  │ ────────────> │  配送中  │ ────────────> │  已完成  │
│ pending  │                  │ confirmed│               │delivering│               │ completed│
└──────────┘                  └──────────┘               └──────────┘               └──────────┘


                                    ┌─────────────────────────────────────────────────────────────────┐
                                    │                        取消流程                                  │
                                    └─────────────────────────────────────────────────────────────────┘

┌──────────┐                  ┌──────────┐                                          ┌──────────┐
│  待确认  │ ──1小时内门店──> │  已取消  │ <────────管理员取消─────────────────────  │  已确认  │
│ pending  │    自主取消      │cancelled │                                          │ confirmed│
└──────────┘                  └──────────┘                                          └──────────┘
     │                              ▲
     │ 超过1小时                    │
     ▼                              │
┌──────────┐    管理员审批    ┌──────────┐
│ 取消申请 │ ───────────────> │  已取消  │
│ 待审批中 │                  │cancelled │
└──────────┘                  └──────────┘


                                    ┌─────────────────────────────────────────────────────────────────┐
                                    │                        恢复流程                                  │
                                    └─────────────────────────────────────────────────────────────────┘

┌──────────┐   供应商拒绝取消   ┌──────────┐   门店重新付款   ┌──────────┐
│  已取消  │ ─────────────────> │  待付款  │ ───────────────> │  待确认  │
│cancelled │   管理员恢复订单   │  unpaid  │                  │ pending  │
└──────────┘                    └──────────┘                  └──────────┘
```

### 6.3 订单取消与恢复流程

#### 6.3.1 门店自主取消（下单后1小时内）

```
┌─────────────────────────────────────────────────────────────┐
│                   门店自主取消流程                           │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │  门店发起取消   │
                    └─────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │ 检查下单时间    │
                    └─────────────────┘
                              │
              ┌───────────────┴───────────────┐
              ▼                               ▼
        [≤1小时]                         [>1小时]
              │                               │
              ▼                               ▼
    ┌─────────────────┐             ┌─────────────────┐
    │  直接取消订单   │             │  提交取消申请   │
    │  状态→cancelled │             │  等待管理员审批 │
    └─────────────────┘             └─────────────────┘
              │                               │
              ▼                               ▼
    ┌─────────────────┐             ┌─────────────────┐
    │  Webhook推送    │             │  通知管理员     │
    │  取消订单通知   │             │  有新的取消申请 │
    └─────────────────┘             └─────────────────┘
              │
              ▼
    ┌─────────────────┐
    │  退款处理       │
    │  (如已支付)     │
    └─────────────────┘
```

#### 6.3.2 管理员审批取消

```
┌─────────────────────────────────────────────────────────────┐
│                   管理员审批取消流程                         │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │  收到取消申请   │
                    └─────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │  联系供应商确认 │
                    │  是否可以取消   │
                    └─────────────────┘
                              │
              ┌───────────────┴───────────────┐
              ▼                               ▼
        [供应商同意]                     [供应商拒绝]
              │                               │
              ▼                               ▼
    ┌─────────────────┐             ┌─────────────────┐
    │  审批通过       │             │  审批拒绝       │
    │  订单→cancelled │             │  通知门店原因   │
    └─────────────────┘             └─────────────────┘
              │                               │
              ▼                               ▼
    ┌─────────────────┐             ┌─────────────────┐
    │  Webhook推送    │             │  订单保持原状态 │
    │  取消订单通知   │             │  门店需继续履约 │
    └─────────────────┘             └─────────────────┘
              │
              ▼
    ┌─────────────────┐
    │  退款处理       │
    └─────────────────┘
```

#### 6.3.3 订单恢复流程

```
┌─────────────────────────────────────────────────────────────┐
│                   订单恢复流程                               │
│        (供应商已备货/配送，无法取消的情况)                    │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │  供应商反馈     │
                    │  无法取消订单   │
                    └─────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │  管理员恢复订单 │
                    └─────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │  订单状态改为   │
                    │  "待付款 unpaid"│
                    └─────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │  通知门店       │
                    │  订单已恢复     │
                    │  请前往付款     │
                    └─────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │  门店完成付款   │
                    └─────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │  订单状态改为   │
                    │  "待确认 pending"│
                    └─────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │  继续正常流程   │
                    └─────────────────┘
```

#### 6.3.4 取消规则汇总

| 场景 | 操作人 | 条件 | 处理方式 | Webhook推送 |
|------|--------|------|----------|-------------|
| 门店自主取消 | 门店 | 下单后≤1小时 | 直接取消 | ✅ 推送取消通知 |
| 门店申请取消 | 门店 | 下单后>1小时 | 提交申请，等待管理员审批 | - |
| 管理员取消 | 管理员 | 任意时间 | 直接取消 | ✅ 推送取消通知 |
| 订单恢复 | 管理员 | 供应商拒绝取消 | 恢复为待付款状态 | ✅ 推送恢复通知 |

---

## 7. 页面结构

### 7.1 APP页面

```
移动端APP
├── 登录/注册
│   ├── 账号密码登录
│   ├── 手机验证码登录（可选）
│   └── 角色切换（多角色用户）
│
├── 门店端
│   ├── 首页 (物料分类入口)
│   ├── 物料列表页
│   ├── 物料详情页 (含供应商报价对比)
│   ├── 购物车页
│   ├── 结算确认页
│   ├── 订单列表页
│   ├── 订单详情页
│   └── 我的 (门店信息、设置)
│
├── 供应商端
│   ├── 首页 (今日订单统计)
│   ├── 订单列表 (待处理/进行中/已完成)
│   ├── 订单详情 (含快捷操作)
│   └── 我的 (供应商信息)
│
└── 管理员端
    ├── 首页 (关键指标)
    ├── 订单监控
    ├── 异常提醒
    └── 快捷查询
```

### 7.2 Web后台页面

```
Web后台
├── 登录页
├── 门店端
│   ├── 首页 (数据看板)
│   ├── 在线订货 (Web端下单)
│   │   ├── 物料浏览
│   │   ├── 购物车
│   │   ├── 结算页
│   │   └── 支付页 (二维码支付)
│   ├── 订单管理
│   │   ├── 订单列表
│   │   ├── 订单详情
│   │   ├── 待付款订单 (显示支付二维码)
│   │   └── 取消申请记录
│   └── 订货统计
│       ├── 按时间统计
│       ├── 按分类统计
│       └── 按供应商统计
│
├── 供应商端
│   ├── 首页 (订单概览)
│   ├── 订单管理
│   │   ├── 订单列表
│   │   ├── 订单详情
│   │   └── 送货单打印
│   ├── 物料管理
│   │   ├── 价格设置
│   │   └── Excel导入
│   └── 配送设置
│
└── 管理员端
    ├── 首页 (数据看板)
    │   ├── 核心指标卡片
    │   ├── 订单趋势图
    │   ├── 供应商排行
    │   ├── 门店排行
    │   └── 热门物料
    ├── 订单管理
    │   ├── 订单列表
    │   ├── 订单详情
    │   ├── 取消申请审批
    │   └── 订单恢复
    ├── 数据汇总
    │   ├── 门店汇总报表
    │   ├── 供应商汇总报表
    │   ├── 物料汇总报表
    │   └── 报表导出
    ├── 供应商管理
    │   ├── 供应商列表
    │   ├── 供应商详情/编辑
    │   ├── 对接配置 (Webhook/API)
    │   └── 代管设置 (价格/起送价/配送)
    ├── 加价管理
    │   ├── 加价开关与概览
    │   ├── 加价规则列表
    │   ├── 新建加价规则（支持组合条件）
    │   ├── Excel批量导入
    │   ├── 加价模拟计算
    │   └── 加价收入统计
    ├── 物料管理
    │   ├── 分类管理
    │   ├── 物料列表
    │   └── 物料详情/编辑
    ├── 门店管理
    │   ├── 门店列表
    │   └── 门店详情/编辑
    └── 系统设置
        ├── Webhook配置
        ├── 送货单模板
        ├── API密钥管理
        └── 操作日志
```

---

## 8. 技术建议

### 8.1 技术栈参考

| 层级 | 技术选型 |
|------|----------|
| 移动端APP | uni-app（推荐，可同时生成APK和H5）/ React Native / Flutter |
| Web前端 | Vue 3 + Element Plus / React + Ant Design |
| 后端 | Node.js (Nest.js) / Java (Spring Boot) / Python (FastAPI) |
| 数据库 | MySQL / PostgreSQL |
| 缓存 | Redis |
| 文件存储 | 阿里云OSS / 腾讯云COS |

### 8.2 APP发布方案

| 平台 | 发布方式 | 说明 |
|------|----------|------|
| Android | APK直接下载 | 无需应用商店审核，通过官网/二维码分发 |
| Android | 应用商店 | 后续可上架各大应用市场（需审核） |
| iOS | 企业签名 | 企业内部分发，无需App Store |
| iOS | TestFlight | 测试分发，最多10000人 |
| H5 | 网页版 | 作为APP的补充，支持浏览器访问 |

### 8.3 APP更新机制

- **热更新**：JS/资源文件更新，无需重新安装
- **强制更新**：重大版本更新，提示用户下载新版本
- **版本检测**：启动时检查版本，提示更新

### 8.4 接口设计原则
- RESTful API 设计
- 统一响应格式
- JWT Token 认证
- 接口版本控制

---

## 9. 扩展功能（后续迭代）

- [ ] 物料收藏功能
- [ ] 常购清单
- [ ] 供应商评价
- [ ] 价格变动通知
- [ ] 订单消息推送（APP推送通知）
- [ ] 对账单生成
- [ ] 数据分析报表
- [ ] 多门店管理（连锁）
- [ ] iOS版本发布

---

## 10. 附录

### 10.1 订单编号规则
格式：`PO` + `年月日` + `4位序号`
示例：`PO202412270001`

### 10.2 状态码定义

**订单状态**

| 状态 | 编码 | 说明 |
|------|------|------|
| 待付款 | unpaid | 订单恢复后等待门店重新付款 |
| 待确认 | pending | 门店已下单/已付款，等待供应商确认 |
| 已确认 | confirmed | 供应商已确认订单 |
| 配送中 | delivering | 订单正在配送 |
| 已完成 | completed | 订单已完成 |
| 已取消 | cancelled | 订单已取消 |

**支付状态**

| 状态 | 编码 | 说明 |
|------|------|------|
| 未支付 | unpaid | 订单未支付或恢复后待重新支付 |
| 已支付 | paid | 订单已完成支付 |
| 已退款 | refunded | 订单取消后已退款 |

**取消申请状态**

| 状态 | 编码 | 说明 |
|------|------|------|
| 待审批 | pending | 等待管理员审批 |
| 已通过 | approved | 管理员已批准取消 |
| 已拒绝 | rejected | 管理员/供应商拒绝取消 |
| 自动取消 | auto_cancelled | 1小时内门店自主取消 |

### 10.3 取消规则配置

| 配置项 | 默认值 | 说明 |
|--------|--------|------|
| 门店自主取消时限 | 1小时 | 下单后多久内可自主取消 |
| 取消申请超时 | 24小时 | 超时未处理自动提醒管理员 |

### 10.4 支付配置

| 配置项 | 默认值 | 说明 |
|--------|--------|------|
| 支付二维码有效期 | 15分钟 | Web端支付二维码过期时间 |
| 未支付订单自动取消 | 30分钟 | 超时未支付自动取消订单 |
| 支持的支付方式 | 微信、支付宝 | 可配置启用/禁用 |
| 支付结果轮询间隔 | 3秒 | Web端轮询支付状态的间隔 |
| 支付手续费率 | 3‰ (0.3%) | 由门店承担的支付手续费 |
| 手续费转嫁开关 | 开启 | 是否将手续费转嫁给门店 |

**支付方式说明：**

| 支付方式 | 编码 | 适用端 | 说明 |
|----------|------|--------|------|
| 微信支付 | wechat | APP+Web | APP调用微信SDK，Web用Native二维码 |
| 支付宝 | alipay | APP+Web | APP调用支付宝SDK，Web用二维码 |
| 线下支付 | offline | - | 特殊情况，管理员手动标记已付款（无手续费） |

### 10.5 支付手续费说明

**手续费计算规则：**
- 手续费率：3‰（千分之三，即0.3%）
- 计算公式：手续费 = 订单金额 × 0.003
- 手续费由门店承担，在结算时自动加到订单总额中
- 线下支付不收取手续费

**手续费示例：**

| 订单金额 | 手续费率 | 手续费 | 门店实付 |
|----------|----------|--------|----------|
| ¥1,000 | 3‰ | ¥3.00 | ¥1,003.00 |
| ¥5,000 | 3‰ | ¥15.00 | ¥5,015.00 |
| ¥10,000 | 3‰ | ¥30.00 | ¥10,030.00 |

**金额展示规则：**
- 结算页：显示商品金额、手续费、实付金额
- 订单详情：显示商品金额、手续费明细
- 供应商端：只显示商品金额（不含手续费，手续费归平台）

**退款规则：**
- 订单取消后自动发起退款
- 退款金额 = 实付金额（含手续费）
- 退款原路返回（微信退微信，支付宝退支付宝）
- 退款到账时间：微信1-3个工作日，支付宝即时到账
- 退款记录可在支付记录中查询

---

## 11. 支付接口对接（利楚扫呗）

系统使用利楚扫呗聚合支付接口，支持微信、支付宝等多种支付方式。

### 11.1 接口概述

| 配置项 | 说明 |
|--------|------|
| 接口文档 | https://help.lcsw.cn/xrmpic/tisnldchblgxohfl/rinsc3 |
| 传输方式 | HTTPS，Content-type: application/json |
| 提交方式 | POST |
| 数据格式 | JSON，UTF-8编码 |
| 签名算法 | MD5 |

### 11.2 核心接口

| 接口 | service_id | 用途 | 适用场景 |
|------|------------|------|----------|
| APP支付下单 | 015 | APP端支付 | 门店APP下单（调用微信/支付宝SDK） |
| 聚合码支付 | 016 | 生成支付二维码 | Web端扫码支付 |
| 支付查询 | 020 | 查询订单状态 | 轮询支付结果 |
| 退款申请 | 030 | 发起退款 | 订单取消退款 |
| 退款查询 | 031 | 查询退款状态 | 确认退款结果 |
| 关闭订单 | 041 | 关闭未支付订单 | 超时取消 |

### 11.3 APP支付流程（service_id=015）

```
┌─────────────────────────────────────────────────────────────┐
│                      APP支付流程                             │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │  门店确认订单   │
                    └─────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │ 后端调用APP     │
                    │ 下单接口(015)   │
                    └─────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │ 返回支付参数    │
                    │ 微信/支付宝SDK  │
                    │ 所需的支付信息  │
                    └─────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │ APP调用支付SDK  │
                    │ 微信/支付宝     │
                    └─────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │ 支付结果回调    │
                    │ (notify_url)    │
                    └─────────────────┘
```

**请求参数示例：**
```json
{
  "pay_ver": "202",
  "pay_type": "010",
  "service_id": "015",
  "merchant_no": "商户号",
  "terminal_id": "终端号",
  "terminal_trace": "订单号",
  "terminal_time": "20241227143000",
  "total_fee": "100300",
  "order_body": "供应链订货",
  "notify_url": "https://xxx.com/api/pay/callback",
  "attach": "订单附加信息",
  "key_sign": "签名"
}
```

> 注：APP端支付通过调用微信/支付宝SDK完成，具体参数根据所选支付SDK文档调整。
```

### 11.4 Web端扫码支付流程（service_id=016 聚合码）

```
┌─────────────────────────────────────────────────────────────┐
│                    Web端扫码支付流程                         │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │  门店确认订单   │
                    └─────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │ 后端调用聚合码  │
                    │ 接口(016)       │
                    └─────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │ 返回 qr_url     │
                    │ (支付链接)      │
                    └─────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │ 前端生成二维码  │
                    │ 展示给用户扫码  │
                    └─────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │ 前端轮询查询    │
                    │ 支付状态(020)   │
                    └─────────────────┘
                              │
              ┌───────────────┴───────────────┐
              ▼                               ▼
        [支付成功]                       [超时/失败]
              │                               │
              ▼                               ▼
    ┌─────────────────┐             ┌─────────────────┐
    │  跳转成功页面   │             │  关闭订单(041)  │
    └─────────────────┘             └─────────────────┘
```

**请求参数示例：**
```json
{
  "pay_ver": "202",
  "pay_type": "000",
  "service_id": "016",
  "merchant_no": "商户号",
  "terminal_id": "终端号",
  "terminal_trace": "订单号",
  "terminal_time": "20241227143000",
  "total_fee": "100300",
  "order_body": "供应链订货",
  "notify_url": "https://xxx.com/api/pay/callback",
  "attach": "订单附加信息",
  "timeout_express": "900",
  "repeated_trace": "1",
  "auto_pay": "1",
  "key_sign": "签名"
}
```

**响应示例：**
```json
{
  "return_code": "01",
  "result_code": "01",
  "qr_url": "https://xxx.lcsw.cn/xxx",
  "merchant_no": "商户号",
  "terminal_id": "终端号",
  "terminal_trace": "订单号",
  "total_fee": "100300"
}
```

### 11.5 支付回调处理

**回调地址：** 在下单时通过 `notify_url` 参数指定

**回调参数（关键字段）：**
```json
{
  "return_code": "01",
  "result_code": "01",
  "pay_type": "010",
  "merchant_no": "商户号",
  "terminal_id": "终端号",
  "terminal_trace": "订单号",
  "out_trade_no": "扫呗订单号",
  "channel_trade_no": "微信/支付宝订单号",
  "total_fee": "100300",
  "receipt_fee": "100300",
  "end_time": "20241227143500",
  "user_id": "用户openid",
  "key_sign": "签名"
}
```

**回调处理逻辑：**
1. 验证签名 `key_sign`
2. 检查 `return_code` 和 `result_code` 是否都为 "01"
3. 更新订单支付状态
4. 返回成功响应：`{"return_code":"01","return_msg":"success"}`

### 11.6 退款接口（service_id=030）

**请求参数示例：**
```json
{
  "pay_ver": "202",
  "pay_type": "000",
  "service_id": "030",
  "merchant_no": "商户号",
  "terminal_id": "终端号",
  "terminal_trace": "退款流水号",
  "terminal_time": "20241227150000",
  "refund_fee": "100300",
  "out_trade_no": "原支付扫呗订单号",
  "order_body": "订单取消退款",
  "key_sign": "签名"
}
```

### 11.7 签名算法

```
1. 将所有参数（除key_sign外）按字典顺序排序
2. 拼接成 a=value1&b=value2&...&z=valueN 格式
3. 在末尾追加 &access_token=令牌值
4. 对拼接串进行MD5加密，得到key_sign
```

**签名示例：**
```
待签名串：attach=&merchant_no=839305812000286&...&total_fee=100300&access_token=xxxxxxxx
key_sign = MD5(待签名串).toLowerCase()
```

### 11.8 支付配置参数

| 配置项 | 说明 | 存储位置 |
|--------|------|----------|
| merchant_no | 商户号 | 系统配置表 |
| terminal_id | 终端号 | 系统配置表 |
| access_token | 签名令牌 | 系统配置表（加密存储） |
| notify_url | 支付回调地址 | 系统配置表 |
